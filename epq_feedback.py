# ----- EPQ_FEEDBACK DICTIONARY -----
EPQ_FEEDBACK = {
    "SCL": {
        "Core": {
            "Low": "Performs best when expectations, workflows, and success criteria are explicitly defined. Work feels manageable when procedures are documented and consistently applied. Effectiveness depends on having clear reference points and minimal ambiguity.",
            "Moderate": "Can operate with partial clarity when basic structure is present. Some ambiguity is manageable if boundaries and priorities are still recognizable. Performance remains stable when guardrails exist.",
            "High": "Rigid structures may feel constraining rather than supportive. Clearly defined processes can be experienced as limiting autonomy. The environment may feel overly controlled or slow."
        },
        "Standard": {
            "Low": "Benefits from structure but does not require complete definition to function. Can tolerate evolving expectations if changes are communicated. Adjustment occurs gradually rather than immediately.",
            "Moderate": "Interprets goals independently and fills in missing details as needed. Does not require constant clarification to proceed. Operates effectively within loosely defined structures.",
            "High": "Naturally reshapes or challenges existing processes. May push against formal systems that feel unnecessary. Tends to redefine structure rather than follow it as designed."
        },
        "Advanced": {
            "Low": "Ambiguity is likely to feel destabilizing. Lack of clarity may reduce confidence in decision-making. Effectiveness depends on structure that advanced environments often do not provide.",
            "Moderate": "Can function in ambiguous conditions with sustained effort. May experience friction when expectations remain undefined for long periods. Performance is possible but requires energy to maintain.",
            "High": "Interprets vague goals without distress. Builds structure where none exists and defines success independently. Operates comfortably in environments with minimal guidance."
        }
    },
    "CCD": {
        "Core": {
            "Low": "Prefers deliberate pacing and sequential decision-making. Time to analyze information supports accuracy and confidence. Fast decision cycles are not required to be effective.",
            "Moderate": "Can handle time pressure when it is occasional. Performs well when urgency is bounded and predictable. Sustained speed may feel taxing.",
            "High": "May feel underutilized by slower environments. Decision cycles can feel unnecessarily drawn out. The pace may limit engagement."
        },
        "Standard": {
            "Low": "Requires time to process information before acting. Can adapt to faster demands with planning and support. Performance remains stable when expectations are clear.",
            "Moderate": "Balances speed and accuracy effectively. Processes information efficiently without sacrificing judgment. Well-matched to environments with moderate urgency.",
            "High": "Operates quickly and often anticipates next steps. Rapid decision-making feels natural and sustainable. Can handle compressed timelines with minimal strain."
        },
        "Advanced": {
            "Low": "Rapid decision cycles may feel overwhelming. Processing speed may not match environmental demands. Risk of cognitive overload increases.",
            "Moderate": "Can keep pace with fast environments but at a cost. Cognitive fatigue may accumulate over time. Recovery becomes important for sustainability.",
            "High": "Synthesizes information rapidly under pressure. Makes confident decisions with limited data. Sustains effectiveness in highly compressed environments."
        }
    },
    "CIL": {
        "Core": {
            "Low": "Functions best with straightforward, well-scoped tasks. Linear problems are easier to manage. Ambiguity is minimized.",
            "Moderate": "Can manage layered problems with guidance. Benefits from frameworks that reduce ambiguity. Complexity is manageable when structured.",
            "High": "May feel under-challenged by simple tasks. Limited complexity can reduce engagement. Problem-solving opportunities feel constrained."
        },
        "Standard": {
            "Low": "Handles routine complexity without difficulty. Deep ambiguity may be avoided when possible. Preference leans toward clarity.",
            "Moderate": "Integrates multiple factors comfortably. Can navigate competing demands without excessive strain. Complexity feels engaging rather than overwhelming.",
            "High": "Actively engages with ambiguous problem spaces. Enjoys solving non-obvious challenges. Complexity is stimulating."
        },
        "Advanced": {
            "Low": "High ambiguity may lead to confusion. Competing variables can feel destabilizing. Disengagement risk increases.",
            "Moderate": "Can perform effectively with complex demands. Requires recovery time after sustained integration. Effort remains high.",
            "High": "Navigates ambiguity fluidly. Integrates competing demands with ease. Thrives in complex, ill-defined environments."
        }
    },
    "CVL": {
        "Core": {
            "Low": "Performs best with predictable conditions. Stability supports confidence and focus. Change is minimal.",
            "Moderate": "Can tolerate occasional change. Adjustment occurs with time and communication. Stability remains important.",
            "High": "Highly stable environments may feel constraining. Limited change can reduce stimulation. Restlessness may emerge."
        },
        "Standard": {
            "Low": "Needs time to adjust to change. Remains effective once adaptation occurs. Sudden shifts may slow momentum.",
            "Moderate": "Adapts to change without sustained distress. Flexibility is balanced with consistency. Well-matched to evolving environments.",
            "High": "Handles frequent change smoothly. Recalibration happens quickly. Change is integrated into daily work."
        },
        "Advanced": {
            "Low": "Constant shifts may feel overwhelming. Predictability is limited. Stress can accumulate quickly.",
            "Moderate": "Can adapt to frequent change with effort. Cumulative stress may occur. Recovery becomes important.",
            "High": "Change is energizing rather than disruptive. Rapid shifts are expected and managed. Thrives in dynamic environments."
        }
    },
    "ERL": {
        "Core": {
            "Low": "Performs best in emotionally safe environments. Pressure is limited and manageable. Stress recovery is quick.",
            "Moderate": "Can manage stress with recovery time. Emotional demands are tolerable when spaced. Sustained pressure may tax resilience.",
            "High": "Comfortable under pressure. May feel under-challenged in low-stress settings. Emotional intensity is manageable."
        },
        "Standard": {
            "Low": "Benefits from support during high-pressure periods. Stress can temporarily disrupt performance. Recovery aids stability.",
            "Moderate": "Maintains composure under stress. Emotional regulation is consistent. Well-matched to moderate pressure.",
            "High": "Sustains performance under prolonged pressure. Emotional demands are navigated effectively. Stress does not significantly impair function."
        },
        "Advanced": {
            "Low": "Risk of burnout increases. Emotional load may exceed capacity. Regulation becomes difficult.",
            "Moderate": "Can function under pressure with intentional recovery. Emotional strain accumulates over time. Sustainability requires support.",
            "High": "Maintains regulation under sustained pressure. High stakes are manageable. Thrives in demanding emotional environments."
        }
    },
    "MSD": {
        "Core": {
            "Low": "Engagement is sustained through predictability. Task completion provides satisfaction. Motivation remains steady.",
            "Moderate": "Enjoys growth within clear boundaries. Progress reinforces engagement. Motivation is stable.",
            "High": "Low challenge may reduce engagement. Boredom can emerge. Sustained motivation may decline."
        },
        "Standard": {
            "Low": "Requires external reinforcement to stay engaged. Motivation fluctuates without feedback. Support enhances consistency.",
            "Moderate": "Balanced motivation through progress and recognition. Engagement is sustainable. Work feels meaningful.",
            "High": "Self-directed and growth-oriented. Challenge fuels engagement. Motivation is internally sustained."
        },
        "Advanced": {
            "Low": "Struggles to sustain engagement. High demands may drain motivation. Disengagement risk increases.",
            "Moderate": "Maintains engagement when purpose is clear. Motivation requires alignment with impact. Ambiguity can weaken drive.",
            "High": "Energized by ownership and challenge. Engagement deepens over time. Motivation is resilient."
        }
    },
    "ICI": {
        "Core": {
            "Low": "Prefers limited interaction. Clear roles reduce friction. Social demands are minimal.",
            "Moderate": "Comfortable with routine collaboration. Communication is functional. Interaction is manageable.",
            "High": "High social demands may feel constraining. Excess coordination can be draining. Focus may suffer."
        },
        "Standard": {
            "Low": "Works best within defined team structures. Interaction is predictable. Boundaries support effectiveness.",
            "Moderate": "Communicates and collaborates effectively. Coordination feels natural. Well-aligned to team-based work.",
            "High": "Actively facilitates alignment. Engages in discussion and negotiation. Social complexity is manageable."
        },
        "Advanced": {
            "Low": "Risk of isolation increases. Misalignment may occur. Coordination demands may exceed comfort.",
            "Moderate": "Can navigate relationships with effort. Interpersonal demands require energy. Effectiveness is possible.",
            "High": "Influences and negotiates across boundaries. Coordination is fluid. Thrives in relationally complex environments."
        }
    },
    "AJL": {
        "Core": {
            "Low": "Prefers clear authority and direction. Decision-making feels secure with guidance. Independence is limited.",
            "Moderate": "Takes initiative within defined limits. Judgment is applied cautiously. Oversight supports confidence.",
            "High": "May feel constrained by oversight. Limited autonomy can frustrate decision-making. Independence is desired."
        },
        "Standard": {
            "Low": "Needs guidance to remain effective. Decision ownership is limited. Support structures are important.",
            "Moderate": "Balances autonomy and support effectively. Judgment is exercised appropriately. Well-aligned to role demands.",
            "High": "Operates confidently with independence. Ownership feels natural. Accountability is manageable."
        },
        "Advanced": {
            "Low": "High risk of decision paralysis. Ambiguity can stall action. Support is insufficient.",
            "Moderate": "Can perform with support structures. Judgment improves with experience. Autonomy is partially manageable.",
            "High": "Exercises judgment and ownership consistently. Accountability is embraced. Optimal alignment with advanced environments."
        }
    }
}
# ----------------------
# Band mapping
# ----------------------
def score_to_band(score):
    """
    Convert numeric score to a short band key (for dict lookup) and descriptive string.
    Returns: (band_key, band_description)
    """
    if score <= 2.0:
        return "Core", "Core Preference (≤ 2.0) — prefers lower environmental load"
    elif score < 3.0:
        return "Standard", "Standard Preference (2.1–2.9) — flexible across environments"
    else:
        return "Advanced", "Advanced Preference (≥ 3.0) — prefers higher environmental load"


# ----------------------
# Resolve feedback for one construct
# ----------------------
def resolve_feedback(construct, environment, score):
    """
    Return the band key and feedback text for a given construct and environment
    """
    band_key, band_desc = score_to_band(score)  # use key for dict lookup
    try:
        text = EPQ_FEEDBACK[construct][environment][band_key]  # only short key
    except KeyError:
        text = f"No feedback found for {construct} / {environment} / {band_key}"
    return band_key, text

def build_employer_report(scores, environment):
    """
    scores = {
        "SCL": 2.6,
        "CCD": 1.9,
        ...
    }
    environment = "Core" | "Standard" | "Advanced"
    """

    report = {}

    for construct, score in scores.items():
        band, feedback = resolve_feedback(construct, environment, score)
        report[construct] = {
            "score": round(score, 2),
            "band": band,
            "environment": environment,
            "feedback": feedback
        }

    return report

def generate_employer_html(report, candidate_id, output_path):
    html = f"""
<html>
<head>
<title>EPQ Employer Report</title>
<style>
body {{ font-family: Arial; margin: 30px; }}
.card {{ border: 1px solid #ddd; padding: 14px; margin-bottom: 12px; border-radius: 8px; }}
h1 {{ margin-bottom: 5px; }}
.small {{ color: #666; font-size: 12px; }}
</style>
</head>
<body>

<h1>Environment Professional Questionnaire</h1>
<div class="small">Candidate ID: {candidate_id} · Confidential Employer Use</div>
<br>
"""

    for c, d in report.items():
        html += f"""
<div class="card">
<b>{c}</b><br>
Band: {d['band']} · Environment: {d['environment']}<br><br>
{d['feedback']}
</div>
"""

    html += """
<div class="small">
This report reflects environmental alignment signals, not clinical traits.
Use alongside interviews and role-specific evaluation.
</div>

</body>
</html>
"""

    with open(output_path, "w", encoding="utf-8") as f:
        f.write(html)

    return output_path
